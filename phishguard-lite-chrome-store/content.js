import{g as p}from"./config.js";const k=new Set(["zip","mov","gq","cf","tk","ml","ga","loan","click","country","uno","quest"]),y=new Set(["bit.ly","t.co","tinyurl.com","goo.gl","is.gd","ow.ly","buff.ly","cutt.ly","rebrand.ly"]),u=new Set(["google.com","gmail.com","youtube.com","facebook.com","amazon.com","netflix.com","microsoft.com","apple.com","paypal.com","ebay.com","walmart.com","target.com","bankofamerica.com","chase.com","wellsfargo.com","citibank.com","usbank.com","github.com","stackoverflow.com","reddit.com","twitter.com","instagram.com","linkedin.com","dropbox.com","spotify.com","discord.com","slack.com","zoom.us"]);function w(e){try{return new URL(e).hostname.toLowerCase()}catch{return null}}function b(e){const n=e.split(".");return n[n.length-1]||""}function L(e){return/\bxn--/i.test(e)}function R(e){return/@/.test(e)}function C(e){try{const n=new URL(e);return(n.pathname+n.search).length>150}catch{return!1}}function E(e,n){if(!n)return!1;try{const o=new URL(e).hostname.replace(/^www\./,""),t=n.match(/([a-z0-9-]+\.)+[a-z]{2,}/i);if(!t)return!1;const s=t[0].toLowerCase().replace(/^www\./,"");return!!(s&&o&&s!==o)}catch{return!1}}const d={m:["rn","nn"],rn:["m"],nn:["m"],l:["I","1","|"],I:["l","1","|"],1:["l","I","|"],"|":["l","I","1"],o:["0"],0:["o"],s:["5"],5:["s"],z:["2"],2:["z"],g:["9"],9:["g"],b:["6"],6:["b"],a:["@"],"@":["a"]};function S(e){const n=[e];for(let o=0;o<e.length;o++){const t=e[o];if(d[t])for(const s of d[t]){const r=e.slice(0,o)+s+e.slice(o+1);n.push(r)}}return n}function f(e,n){const o=[];for(let t=0;t<=n.length;t++)o[t]=[t];for(let t=0;t<=e.length;t++)o[0][t]=t;for(let t=1;t<=n.length;t++)for(let s=1;s<=e.length;s++)n.charAt(t-1)===e.charAt(s-1)?o[t][s]=o[t-1][s-1]:o[t][s]=Math.min(o[t-1][s-1]+1,o[t][s-1]+1,o[t-1][s]+1);return o[n.length][e.length]}function v(e){const n=e.replace(/^www\./,"");if(u.has(n))return{isLookalike:!1,reason:null};for(const t of u){const s=f(n,t);if(s<=1)return{isLookalike:!0,reason:`Lookalike domain: ${n} vs ${t} (edit distance: ${s})`}}const o=S(n);for(const t of o)for(const s of u)if(f(t,s)<=1)return{isLookalike:!0,reason:`Lookalike domain: ${n} vs ${s} (character shape variation)`};return{isLookalike:!1,reason:null}}function x(e,n){const o=[];let t=0;const s=w(e);if(!s)return{score:0,reasons:o,label:"Safe"};const r=b(s);k.has(r)&&(t+=40,o.push(`High-risk TLD: .${r}`)),L(s)&&(t+=25,o.push("Punycode/homoglyph in hostname")),y.has(s)&&(t+=20,o.push("URL shortener host")),C(e)&&(t+=10,o.push("Very long URL path/query"));try{const a=new URL(e);R(a.pathname)&&(t+=20,o.push("Contains '@' in the path"))}catch{}E(e,n)&&(t+=15,o.push("Link text domain mismatch"));const i=v(s);i.isLookalike&&(t+=35,o.push(i.reason));const l=t>=50?"High Risk":t>=20?"Caution":"Safe";return{score:t,reasons:o,label:l}}function g(e){const n=document.createElement("span");return n.className="pg-badge",n.textContent=e,n}function h(e){const n=document.createElement("div");return n.className="pg-tooltip",n.innerHTML=`<strong>Why flagged:</strong><ul>${e.map(o=>`<li>${o}</li>`).join("")}</ul>`,n}function U(e,n,o){if(e.dataset.pgDone)return;e.dataset.pgDone="1";const t=g(n);t.style.marginLeft="6px";const s=h(o);s.style.display="none";const r=document.createElement("span");r.className="pg-wrap",r.style.position="relative",r.appendChild(t),r.appendChild(s),t.addEventListener("mouseenter",()=>{s.style.display="block"}),t.addEventListener("mouseleave",()=>{s.style.display="none"}),e.insertAdjacentElement("afterend",r)}function H(){const e=document.createElement("button");return e.type="button",e.textContent="Report",e.className="pg-report-btn",e}function D(e,n,o){if(e.dataset.pgDone)return;e.dataset.pgDone="1";const t=g(n);t.style.marginLeft="6px";const s=h(o);s.style.display="none";const r=H(),i=document.createElement("span");i.className="pg-wrap",i.style.position="relative",i.appendChild(t),i.appendChild(s),i.appendChild(r),t.addEventListener("mouseenter",()=>{s.style.display="block"}),t.addEventListener("mouseleave",()=>{s.style.display="none"}),r.addEventListener("click",()=>{const l={type:"pg_report_suspicious",url:e.href,linkText:e.textContent||"",pageUrl:location.href,reasons:o};chrome.runtime.sendMessage(l,a=>{if(chrome.runtime.lastError){console.warn("Report error:",chrome.runtime.lastError.message);return}r.textContent=a!=null&&a.ok?"Reported âœ“":"Error",setTimeout(()=>r.textContent="Report",1500)})}),e.insertAdjacentElement("afterend",i)}let c={enabled:!0,minScore:20,enableReporting:!1,apiUrl:p()};chrome.storage.sync.get(["enabled","minScore","enableReporting","apiUrl"],e=>{c={enabled:e.enabled??!0,minScore:e.minScore??20,enableReporting:e.enableReporting??!1,apiUrl:e.apiUrl??p()},console.log("PhishGuard settings loaded:",c),m()});async function T(e,n){try{if(!e||e.trim()===""||e.startsWith("#")||e.startsWith("mailto:")||e.startsWith("javascript:"))return console.log("Skipping invalid URL for cloud scoring:",e),null;try{new URL(e)}catch{return console.log("Malformed URL, skipping cloud scoring:",e),null}if(["mail.google.com","www.linkedin.com","linkedin.com","outlook.office.com","outlook.live.com"].includes(window.location.hostname))return console.log("Skipping cloud scoring in restricted context due to CSP restrictions:",window.location.hostname),null;const t=await fetch(`${c.apiUrl}/score`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e,linkText:n})});return t.ok?await t.json():(console.warn("Cloud scoring failed:",t.status,t.statusText),null)}catch(o){return console.warn("Cloud scoring error:",o),null}}function A(e,n){if(!n)return e;const o=Math.max(e.score,n.score),t=[...e.reasons];n.reasons.forEach(r=>{t.includes(r)||t.push(`[Cloud] ${r}`)});const s=o>=50?"High Risk":o>=20?"Caution":"Safe";return{score:o,reasons:t,label:s,hasCloudScore:!0}}async function N(e){var l;if(!c.enabled)return;const n=e.getAttribute("href");if(!n||n.startsWith("#")||n.startsWith("mailto:"))return;const o=((l=e.textContent)==null?void 0:l.trim())||null,t=x(n,o);let s=t;const i=["mail.google.com","www.linkedin.com","linkedin.com","outlook.office.com","outlook.live.com"].includes(window.location.hostname);if(c.enableReporting&&!i)try{const a=await T(n,o);a&&(s=A(t,a))}catch(a){console.warn("Cloud scoring failed, using local score only:",a)}s.score>=(c.minScore||20)&&(c.enableReporting&&!i?D(e,s.label,s.reasons):U(e,s.label,s.reasons))}function m(e=document){e.querySelectorAll("a[href]").forEach(o=>N(o))}const z=new MutationObserver(e=>{for(const n of e)n.addedNodes.forEach(o=>{o.nodeType===Node.ELEMENT_NODE&&m(o)})});z.observe(document.documentElement,{subtree:!0,childList:!0});m();
